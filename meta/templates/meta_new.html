<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>New Meta Ticket</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 2rem; background: #050810; color: #e5e7eb; }
        a { color: #38bdf8; text-decoration: none; }
        a:hover { text-decoration: underline; }
        label { display:block; margin-top:1rem; font-weight:500; }
        input[type="text"], textarea, select {
          width:100%;
          box-sizing:border-box;
          padding:0.4rem 0.5rem;
          margin-top:0.2rem;
          background:#020617;
          border:1px solid #1f2937;
          border-radius:0.4rem;
          color:#e5e7eb;
          font-family:inherit;
          font-size:0.9rem;
        }
        textarea { min-height:6rem; }
        .actions { margin-top:1.5rem; display:flex; gap:0.75rem; align-items:center; }
        button {
          background:#2563eb;
          border:1px solid #1d4ed8;
          color:#fff;
          padding:0.5rem 1rem;
          border-radius:0.5rem;
          cursor:pointer;
          font-weight:500;
        }
        .error {
          margin-bottom:1rem;
          padding:0.5rem 0.75rem;
          background:#450a0a;
          border:1px solid #7f1d1d;
          border-radius:0.4rem;
          color:#fecaca;
          font-size:0.9rem;
        }
        .hint { font-size:0.8rem; color:#9ca3af; margin-top:0.2rem; }
        .container{max-width: 930px;margin: auto;}
        .summary-body h1,
.summary-body h2,
.summary-body h3 {
    margin-top: 0.75rem;
    margin-bottom: 0.25rem;
}

.summary-body p {
    margin: 0.25rem 0;
}

.summary-body code {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.85rem;
    background: #020617;
    padding: 0.1rem 0.25rem;
    border-radius: 0.25rem;
}

.summary-body pre {
    background: #020617;
    padding: 0.5rem 0.75rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    font-size: 0.85rem;
}

    </style>
</head>
<body>

<div class="container">

    <p><a href="{{ url_for('meta.meta_index') }}">← Back to tickets</a></p>

    <h1>Create New Meta Ticket</h1>

    {% if error %}
    <div class="error">{{ error }}</div>
    {% endif %}

    <form method="post">

        <label>
            Title
            <input type="text" name="title" required
                   value="{{ (form.title or '') if form else '' }}">
        </label>

        {% if using_ai %}
        <label>
            Component
            <input type="text" name="component"
                   placeholder="e.g. planner, executor, ui/chat"
                   value="{{ (form.component or '') if form else '' }}">
            <div class="hint">Rough area of the codebase this affects.</div>
        </label>
        {% endif %}

        <label>
            Priority
            {% set current_prio = (form.priority or 'medium') if form else 'medium' %}
            <select name="priority">
                <option value="low" {% if current_prio=='low' %}selected{% endif %}>Low</option>
                <option value="medium" {% if current_prio=='medium' %}selected{% endif %}>Medium</option>
                <option value="high" {% if current_prio=='high' %}selected{% endif %}>High</option>
            </select>
        </label>

        <label>
            Category
            <input type="text" name="category"
                   placeholder="e.g. bob, ghostfrog, infra, bug, feature"
                   value="{{ (form.category or '') if form else '' }}">
            <div class="hint">Used for filtering tickets on the index page.</div>
        </label>

        {# Parent ticket selector #}
        {% set parent_value = '' %}
        {% if form and form.parent_id %}
        {% set parent_value = form.parent_id %}
        {% elif ticket and ticket.parent_id %}
        {% set parent_value = ticket.parent_id %}
        {% endif %}

        <label>
            Parent ticket (optional)
            <select name="parent_id">
                <option value="">None</option>

                {% if all_tickets %}
                {% for t in all_tickets %}

                {# Only show REAL parents (tickets with no parent_id) #}
                {% if not t.parent_id %}

                {# Don't allow a ticket to be its own parent when editing #}
                {% if not ticket or t.ticket_id != ticket.ticket_id %}
                <option value="{{ t.ticket_id }}"
                        {% if parent_value== t.ticket_id %}selected{% endif %}>
                    {{ t.ticket_id }} – {{ t.title or t.summary }}
                </option>
                {% endif %}

                {% endif %}
                {% endfor %}
                {% endif %}
            </select>

            <div class="hint">Choose a parent ticket to group this under. Only top-level tickets appear here.</div>
        </label>

        {% if using_ai %}
        <label>
            Kind
            {% set current_kind = (form.kind or 'self_improvement') if form else 'self_improvement' %}
            <select name="kind">
                <option value="self_improvement"
                        {% if current_kind=='self_improvement' %}selected{% endif %}>
                    Self improvement (Bob/Chad fix themselves)
                </option>
                <option value="action"
                        {% if current_kind=='action' %}selected{% endif %}>
                    Action (do the thing using tools)
                </option>
            </select>
            <div class="hint">
                Self improvement = change code & run pytest.<br>
                Action = use tools (email, scripts, etc.), no codemods.
            </div>
        </label>
        {% endif %}

        <label>
            Summary
            <textarea name="summary"
                      placeholder="Short description of what this ticket is about. Markdown supported.">{{ (form.summary or '') if form else '' }}</textarea>
            <div class="hint">You can write Markdown here (headings, lists, code blocks, etc.).</div>
        </label>

        {% if using_ai %}
        <label>
            Acceptance criteria
            <textarea name="acceptance_criteria"
                      placeholder="- When I do X, Y happens&#10;- Z error no longer appears">{{ (form.acceptance_criteria or '') if form else '' }}</textarea>
            <div class="hint">One per line. Lines starting with <code>-</code> or bullets are fine.</div>
        </label>
        {% endif %}

        {% if using_ai %}
        <label>
            Suggested steps
            <textarea name="suggested_steps"
                      placeholder="- Review current implementation in ...&#10;- Add tests for ...">{{ (form.suggested_steps or '') if form else '' }}</textarea>
            <div class="hint">One step per line. This is what Bob/Chad can follow later.</div>
        </label>
        {% endif %}

        {% if using_ai %}
        <label>
            Safe Paths (one per line)
            <textarea name="safe_paths" rows="5"
                      placeholder="ui/chat_ui.html&#10;static/css/chat.css"
                      class="form-control">{{ form.safe_paths if form.safe_paths else "" }}</textarea>
            <div class="hint">Paths inside the repo that Bob/Chad are allowed to edit.</div>
        </label>
        {% endif %}

        <div class="actions">
            <button type="submit">Create Ticket</button>
        </div>
    </form>

</div>

</body>
</html>
